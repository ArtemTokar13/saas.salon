{% load i18n %}
<!-- Cookie Consent Banner -->
<div id="cookie-consent-banner" class="hidden fixed bottom-0 left-0 right-0 bg-white shadow-2xl border-t-4 border-gray-600 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
            <div class="flex-1">
                <h3 class="text-lg font-bold text-gray-900 mb-2">{% trans "We use cookies" %}</h3>
                <p class="text-sm text-gray-600">
                    {% trans "We use essential cookies to make our site work. With your consent, we may also use non-essential cookies to improve user experience and analyze website traffic. By clicking 'Accept All', you agree to our use of cookies." %}
                    <a href="{% url 'cookie_policy' %}" class="text-blue-600 hover:underline">{% trans "Learn more" %}</a>
                </p>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                <button onclick="cookieConsent.acceptAll()" 
                        class="px-6 py-2 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700 transition-colors">
                    {% trans "Accept All" %}
                </button>
                <button onclick="cookieConsent.acceptEssential()" 
                        class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition-colors">
                    {% trans "Essential Only" %}
                </button>
                <a href="{% url 'cookie_settings' %}" 
                   class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors text-center">
                    {% trans "Customize" %}
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Cookie Consent JavaScript -->
<script>
const cookieConsent = {
    STORAGE_KEY: 'cookie_consent',
    EXPIRY_DAYS: 365,

    init() {
        const consent = this.getConsent();
        if (!consent) {
            this.showBanner();
        } else {
            this.applyConsent(consent);
        }
    },

    showBanner() {
        document.getElementById('cookie-consent-banner').classList.remove('hidden');
    },

    hideBanner() {
        document.getElementById('cookie-consent-banner').classList.add('hidden');
    },

    acceptAll() {
        const consent = {
            essential: true,
            preference: true,
            timestamp: new Date().toISOString()
        };
        this.saveConsent(consent);
        this.hideBanner();
        this.applyConsent(consent);
    },

    acceptEssential() {
        const consent = {
            essential: true,
            preference: false,
            timestamp: new Date().toISOString()
        };
        this.saveConsent(consent);
        this.hideBanner();
        this.applyConsent(consent);
    },

    saveConsent(consent) {
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(consent));
        // Also set a cookie as fallback
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + this.EXPIRY_DAYS);
        document.cookie = `${this.STORAGE_KEY}=${JSON.stringify(consent)}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Lax`;
    },

    getConsent() {
        try {
            const stored = localStorage.getItem(this.STORAGE_KEY);
            return stored ? JSON.parse(stored) : null;
        } catch (e) {
            // Fallback to cookie
            const match = document.cookie.match(new RegExp('(^| )' + this.STORAGE_KEY + '=([^;]+)'));
            return match ? JSON.parse(match[2]) : null;
        }
    },

    applyConsent(consent) {
        // Apply preference cookies
        if (consent.preference) {
            // Enable preference features (language, theme, etc.)
            console.log('Preference cookies enabled');
        }
    },

    // loadGoogleAnalytics() {
    //     // Example implementation
    //     window.dataLayer = window.dataLayer || [];
    //     function gtag(){dataLayer.push(arguments);}
    //     gtag('js', new Date());
    //     gtag('config', 'GA_MEASUREMENT_ID');
    // },

    resetConsent() {
        localStorage.removeItem(this.STORAGE_KEY);
        document.cookie = `${this.STORAGE_KEY}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
        location.reload();
    }
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    cookieConsent.init();
});
</script>