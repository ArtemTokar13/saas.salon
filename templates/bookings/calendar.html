{% extends 'Layout.html' %}
{% load i18n static %}
{% load booking_extras %}

{% block title %}Booking Calendar - {{ company.name }}{% endblock %}
{% block header %}

<!-- Django JavaScript translations -->
<script src="{% url 'javascript-catalog' %}"></script>

<link href="https://cdn.syncfusion.com/ej2/26.1.35/material.css" rel="stylesheet" />
<script src="https://cdn.syncfusion.com/ej2/26.1.35/dist/ej2.min.js"></script>
<script>
    ej.base.registerLicense("{{ ej_base_license_key }}");
</script>


<!-- App calendar JS (buildCalendar will choose DayPilot if available) -->
<script src="{% static 'js/calendar.js' %}?v=2.5"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
    body {
        height: 100%;
        overflow: auto;
    }
    
    /* Main calendar container - scroll-enabled */
    #calendar {
        min-height: calc(100vh - 260px);
        height: calc(100vh - 260px);
        overflow: auto;
        overflow-x: auto;
    }
    
    /* Syncfusion scheduler custom overrides */
    .e-schedule {
        overflow: auto !important;
    }
    
    .e-schedule .e-vertical-view {
        overflow: auto !important;
    }
    
    .e-schedule-table {
        display: table !important;
    }
    
    /* Ensure time column is always visible on all devices */
    .e-schedule .e-time-cells-wrap,
    .e-schedule .e-time-slots,
    .e-schedule .e-left-indent-wrap {
        display: block !important;
        visibility: visible !important;
        min-width: 70px !important;
    }
    
    .e-schedule .e-time-slots .e-time-cells {
        display: table-cell !important;
    }
    
    /* Show time labels clearly on all devices with HH:mm format */
    .e-schedule .e-time-label {
        display: block !important;
        font-size: 12px !important;
        padding: 4px !important;
        white-space: nowrap !important;
        overflow: visible !important;
        text-overflow: clip !important;
    }
    
    /* Prevent time column from collapsing on mobile/tablet */
    .e-schedule .e-vertical-view .e-left-indent,
    .e-schedule .e-month-view .e-left-indent-wrap {
        min-width: 70px !important;
        width: 70px !important;
    }
    
    /* Customize tui.Calendar columns for multi-staff view */
    .tui-calendar-table .tui-day-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    
    .tui-calendar-sidebar {
        min-width: 150px;
        max-width: 200px;
    }
    
    .tui-calendar-list-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
    }
    
    /* Improve time grid column spacing */
    .tui-time-grid {
        flex: 1;
        overflow: auto;
    }
    
    .tui-grid-cell {
        border-right: 1px solid #e5e7eb;
    }
    
    /* Ensure date range in toolbar header is fully visible */
    .e-schedule .e-toolbar .e-date-range {
        font-weight: 600;
        font-size: 14px;
    }
    
    .e-schedule .e-toolbar-item .e-tbar-btn {
        white-space: nowrap;
    }

    /* Примусово вимикаємо мобільний режим */
    .e-schedule.e-device {
        width: 100% !important;
        height: 100% !important;
        font-size: 14px !important;
    }

    /* Показуємо хвилини в таймлайні */
    .e-schedule.e-device .e-timeline-header-wrapper .e-header-cells {
        white-space: nowrap !important;
        font-size: 12px !important;
    }

    
    /* iPad and tablet specific fixes */
    @media (max-width: 1024px) {
        /* Ensure time column stays visible with full HH:mm format */
        .e-schedule .e-time-cells-wrap {
            min-width: 70px !important;
            flex-shrink: 0 !important;
        }
        
        .e-schedule .e-time-label {
            white-space: nowrap !important;
            font-size: 12px !important;
        }
        
        /* Make date headers more readable on tablets */
        .e-schedule .e-date-header-container {
            font-size: 12px !important;
        }
        
        /* Show full date in toolbar on iPad/tablet */
        .e-schedule .e-toolbar .e-date-range {
            min-width: 150px !important;
            white-space: nowrap !important;
            overflow: visible !important;
            text-overflow: clip !important;
        }
        
        .e-schedule .e-toolbar .e-tbar-btn-text {
            display: inline !important;
        }
        
        /* Ensure horizontal scroll works properly */
        #calendar {
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch !important;
        }
        
        /* Keep staff columns readable */
        .e-schedule .e-header-cells {
            min-width: 120px !important;
        }
    }
    
    /* Mobile specific adjustments */
    @media (max-width: 768px) {
        .e-schedule .e-time-label {
            font-size: 11px !important;
            padding: 2px !important;
            white-space: nowrap !important;
        }
        
        .e-schedule .e-left-indent,
        .e-schedule .e-time-cells-wrap {
            min-width: 65px !important;
            width: 65px !important;
        }
        
        /* Ensure time slots have enough space for HH:mm */
        .e-schedule .e-time-slots {
            min-width: 65px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="h-screen flex flex-col bg-gray-50 overflow-hidden relative">
    <!-- Fixed Add Button -->
    <a href="/bookings/book/{{ company.id }}/" class="fixed bottom-8 right-8 z-50 flex items-center justify-center w-16 h-16 bg-black text-white rounded-full hover:bg-gray-800 transition shadow-2xl">
        <i class="fas fa-plus text-2xl font-bold"></i>
    </a>
    
    <div class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 w-full flex flex-col overflow-hidden">
        <!-- Day Schedule Calendar -->
        <div class="bg-white rounded-lg shadow flex-1 flex flex-col min-h-0 overflow-hidden">
            {% comment %}<div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-4">
                    <a href="?date={{ current_date|date:"Y-m-d" }}&prev=1" class="text-gray-600 hover:text-gray-800 flex items-center">
                        <i class="fas fa-chevron-left mr-2"></i>
                    </a>
                    <input type="text" id="date-picker" class="text-sm font-bold text-gray-900 bg-transparent border-none cursor-pointer" value="{{ current_date|date:'Y-m-d' }}" readonly>
                    <a href="?date={{ current_date|date:"Y-m-d" }}&next=1" class="text-gray-600 hover:text-gray-800 flex items-center">
                        <i class="fas fa-chevron-right ml-2"></i>
                    </a>
                </div>
                <div>
                    <a href="?date={{ today|date:"Y-m-d" }}" class="text-sm text-gray-600 hover:text-gray-800">Today</a>
                </div>
            </div>
            <!-- Staff tabs -->
            {% if request.user.userprofile.is_admin %}
                <div class="relative">
                    <!-- Scroll buttons -->
                    <button id="scroll-left" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white shadow-lg rounded-full p-2 hover:bg-gray-100 transition">
                        <i class="fas fa-chevron-left text-gray-700"></i>
                    </button>
                    <button id="scroll-right" class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white shadow-lg rounded-full p-2 hover:bg-gray-100 transition">
                        <i class="fas fa-chevron-right text-gray-700"></i>
                    </button>
                    
                    <!-- Scrollable staff container -->
                    <div id="staff-tabs" class="overflow-x-auto flex gap-4 px-10 py-2 scrollbar-hide" style="scroll-behavior: smooth;">
                        <!-- All staff option -->
                        <button class="staff-tab flex-shrink-0 flex flex-col items-center gap-2 group" data-staff-id="all">
                            <div class="relative">
                                <div class="staff-avatar w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center border-4 border-transparent transition">

                                    <i class="fas fa-users text-gray-600 text-lg"></i>
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs font-semibold text-gray-700">All</div>
                            </div>
                        </button>
                        
                        {% for s in staff_list %}
                            <button class="staff-tab flex-shrink-0 flex flex-col items-center gap-2 group" data-staff-id="{{ s.id }}">
                                <div class="relative">
                                    <!-- Avatar circle -->
                                    {% if s.avatar %}
                                        <img src="{{ s.avatar }}" class="staff-avatar w-12 h-12 rounded-full object-cover border-4 border-transparent transition" alt="{{ s.title }}">
                                    {% else %}
                                        <div class="staff-avatar w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center border-4 border-transparent transition">
                                            <i class="fas fa-user text-gray-500 text-lg"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="text-center">
                                    <!-- Percentage bar -->
                                    <div class="w-12 h-1.5 bg-gray-200 rounded-full mb-1 overflow-hidden">
                                        <div class="h-full {% if staff_occupancy %}{% if staff_occupancy|get_item:s.id >= 80 %}bg-red-500{% elif staff_occupancy|get_item:s.id >= 50 %}bg-yellow-500{% else %}bg-green-500{% endif %}{% else %}bg-gray-300{% endif %} transition-all" 
                                             style="width: {% if staff_occupancy %}{{ staff_occupancy|get_item:s.id }}{% else %}0{% endif %}%"></div>
                                    </div>
                                    <div class="text-xs font-semibold text-gray-700 truncate max-w-16">{{ s.name }}</div>
                                </div>
                            </button>
                        {% endfor %}
                    </div>
                </div>
                
                <style>
                    .scrollbar-hide::-webkit-scrollbar {
                        display: none;
                    }
                    .scrollbar-hide {
                        -ms-overflow-style: none;
                        scrollbar-width: none;
                    }
                    .staff-tab.active .staff-avatar {
                        border-color: #e9cd18 !important;
                    }
                </style>
                
                <script>
                    // Horizontal scroll functionality
                    document.getElementById('scroll-left').addEventListener('click', () => {
                        document.getElementById('staff-tabs').scrollBy({ left: -200, behavior: 'smooth' });
                    });
                    document.getElementById('scroll-right').addEventListener('click', () => {
                        document.getElementById('staff-tabs').scrollBy({ left: 200, behavior: 'smooth' });
                    });
                </script>
            {% endif %}{% endcomment %}
            <div id="calendar" class="border rounded flex-1 min-h-0 overflow-auto">
            </div>
        </div>
    </div>
</div>

{% block hide_footer %}{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', () => {
    const rawBookings = {{ events_json|safe }};
    const staffList = {{ resources_json|safe }};
    // Parse staff occupancy safely (if not already available)
    const staffOccupancyObj = {{ staff_occupancy|safe }} || {};
    const currentDate = new Date('{{ current_date|date:"Y-m-d" }}');
    const dayStart = {{ day_start }};
    const dayEnd = {{ day_end }};
    
    // Attach occupancy data to staffList
    staffList.forEach(staff => {
        staff.occupancy = staffOccupancyObj[staff.id] || 0;
    });
    
    buildCalendar(rawBookings, staffList, currentDate, dayStart, dayEnd);
});

document.addEventListener('DOMContentLoaded', () => {

    const staffTabs = document.querySelectorAll('.staff-tab');

    staffTabs.forEach(tab => {
        tab.addEventListener('click', () => {

            // прибрати active з усіх
            staffTabs.forEach(t => t.classList.remove('active'));

            // додати active до вибраного
            tab.classList.add('active');

            // (опціонально) ID працівника
            const staffId = tab.dataset.staffId;
            console.log('Selected staff:', staffId);
        });
    });

});

// Initialize date picker
flatpickr("#date-picker", {
    dateFormat: "Y-m-d",
    altInput: true,
    altFormat: "F j, Y",
    onChange: function(selectedDates, dateStr, instance) {
        window.location.href = "?date=" + dateStr;
    }
});
</script>
{% endblock %}
