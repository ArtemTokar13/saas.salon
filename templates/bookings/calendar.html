{% extends 'Layout.html' %}
{% load i18n %}

{% block title %}Booking Calendar - {{ company.name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Booking Calendar</h1>
                    <p class="text-gray-600 mt-1">{{ company.name }}</p>
                </div>
                <a href="{% url 'company_dashboard' %}" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Day Schedule Calendar -->
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-4">
                    <a href="?date={{ current_date|date:"Y-m-d" }}&prev=1" class="text-blue-600 hover:text-blue-800 flex items-center">
                        <i class="fas fa-chevron-left mr-2"></i>
                    </a>
                    <h2 class="text-2xl font-bold text-gray-900">{{ current_date }}</h2>
                    <a href="?date={{ current_date|date:"Y-m-d" }}&next=1" class="text-blue-600 hover:text-blue-800 flex items-center">
                        <i class="fas fa-chevron-right ml-2"></i>
                    </a>
                </div>
                <div>
                    <a href="?date={{ today|date:"Y-m-d" }}" class="text-sm text-gray-600 hover:text-gray-800">Today</a>
                </div>
            </div>
            <!-- Staff tabs -->
            <div class="mb-4">
                <div class="flex space-x-2 flex-wrap" id="staff-tabs">
                    <button class="staff-tab px-3 py-1 rounded bg-blue-600 text-white text-sm" data-staff-id="all">All</button>
                    {% for s in staff_list %}
                        <button class="staff-tab px-3 py-1 rounded bg-gray-100 text-gray-700 text-sm" data-staff-id="{{ s.id }}">{{ s.name }}</button>
                    {% endfor %}
                </div>
            </div>
            <div id="calendar" class="overflow-auto border rounded">
                <div id="fc-calendar" style="min-height:600px;"></div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-center">
                    <p class="text-gray-600 mb-2">Total Bookings</p>
                    <p class="text-3xl font-bold text-gray-900">{{ bookings|length }}</p>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-center">
                    <p class="text-gray-600 mb-2">Pending</p>
                    <p class="text-3xl font-bold text-yellow-600">
                        {{ bookings|length }}
                        {% comment %}TODO: Add filter for pending{% endcomment %}
                    </p>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-center">
                    <p class="text-gray-600 mb-2">Confirmed</p>
                    <p class="text-3xl font-bold text-green-600">
                        {{ bookings|length }}
                        {% comment %}TODO: Add filter for confirmed{% endcomment %}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar CSS & JS (canonical global bundle) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function updateStatus(bookingId, status) {
    const csrftoken = getCookie('csrftoken');
    
    try {
        const response = await fetch(`/bookings/update-status/${bookingId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken
            },
            body: `status=${status}`
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Error updating booking status');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error updating booking status');
    }
}

// FullCalendar setup
document.addEventListener('DOMContentLoaded', () => {
    const events = {{ events_json|safe }};
    const staff = {{ resources_json|safe }};
    const calendarEl = document.getElementById('fc-calendar');

    const allEvents = events.slice();

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridDay',
        headerToolbar: false,
        editable: true,
        eventDurationEditable: true,
        events: [],
        eventDrop: function(info) {
            const event = info.event;
            const staffId = event.extendedProps.staff_id;
            const startTime = event.start.toISOString().split('T')[1].substring(0, 5);

            const csrftoken = getCookie('csrftoken');
            fetch(`/bookings/api/update-booking/${event.id}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `staff_id=${staffId}&start_time=${startTime}`
            }).then(r => r.json()).then(data => {
                if (!data.success) {
                    alert('Error: ' + (data.error || 'Could not update booking'));
                    info.revert();
                }
            }).catch(err => {
                console.error(err);
                alert('Error updating booking');
                info.revert();
            });
        },
        eventResize: function(info) {
            alert('Duration changes not yet implemented');
            info.revert();
        }
    });

    calendar.render();

    function loadEvents(filter) {
        calendar.removeAllEvents();
        const toShow = (filter === 'all') ? allEvents : allEvents.filter(e => String(e.extendedProps.staff_id) === String(filter));
        toShow.forEach(e => calendar.addEvent(e));
    }

    // initial load
    loadEvents('all');

    // setup tabs
    const tabs = document.querySelectorAll('.staff-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // update active state
            tabs.forEach(t => t.classList.remove('bg-blue-600','text-white'));
            tab.classList.add('bg-blue-600','text-white');
            const staffId = tab.dataset.staffId || 'all';
            loadEvents(staffId);
        });
    });
});
</script>
{% endblock %}
